---
title: "Untitled"
description: |
  A new article created using the Distill format.
author:
  - name: Nora Jones 
    url: https://example.com/norajones
    affiliation: Spacely Sprockets
    affiliation_url: https://example.com/spacelysprokets
date: "`r Sys.Date()`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(ggplot2)
library(plotly)
library(lubridate)
```

## Subscription

```{r}
sub <- 
  read.csv("user_sample.csv",
           sep = ";") %>% 
  mutate(user_started_date = as.Date(user_started_date)) %>% 
  as_tibble()

sub %>% glimpse()
```


### area

```{r}
sub %>% 
  ggplot() +
  geom_bar(mapping = aes(x = area)) +
  coord_flip()
```

```{r}
sub %>% 
  mutate(year = as.factor(year(user_started_date))) %>% 
  group_by(year) %>% 
  summarise(sum_price = sum(monthly_price),
            subscrips = n()
  ) %>% 
  ungroup() 
```

```{r}
sub %>% 
  mutate(
    year = as.factor(year(user_started_date)),
    month = as.factor(month(user_started_date))
  ) %>% 
  group_by(year, month) %>% 
  summarise(sum_price = sum(monthly_price),
            subscrips = n()
  ) %>% 
  ungroup() %>% 
  ggplot() +
  geom_point(mapping = aes(x = sum_price, y = subscrips))
```

```{r}
test_ratio <- 
  sub %>% 
  mutate(
    year = as.factor(year(user_started_date)),
    month = as.factor(month(user_started_date))
  ) %>% 
  group_by(year, month) %>% 
  summarise(sum_price = sum(monthly_price),
            subscrips = n()
  ) %>% 
  ungroup() 

ratio <- max(test_ratio$subscrips)/max(test_ratio$sum_price)
test_ratio %>% 
  ggplot() +
  geom_col(aes(x = month, y = subscrips)) +
  geom_line(aes(x = month, y = sum_price * ratio, group = 1)) +
  scale_y_continuous("Count", sec.axis = sec_axis(~ . / ratio, name = "Odds Ratio"))+
  facet_wrap(~year)
```


```{r}
library(modelr)

test_model <- 
  sub %>% 
  mutate(
    year = as.factor(year(user_started_date)),
    month = as.factor(month(user_started_date))
  ) %>% 
  group_by(year, month) %>% 
  summarise(sum_price = sum(monthly_price),
            subscrips = n()
  ) %>% 
  ungroup()  

mod <- lm(sum_price ~ subscrips, data = test_model)

test_model_2 <- 
  test_model %>% 
  add_residuals(mod) %>% 
  mutate(resid = exp(resid))

ggplot(data = test_model_2) + 
  geom_boxplot(mapping = aes(x = year, y = resid))
```


```{r}
sub %>% 
  group_by(area) %>% 
  count() %>% 
  arrange(desc(n))
```


```{r}
sub %>% 
  summarise(
    min_date = min(user_started_date),
    max_date = max(user_started_date)
  )
```

## Claims

```{r}
cla <- 
  read.csv("claims_sample.csv",
           sep = ";") %>% 
  as_tibble() %>% 
  mutate(claim_filed_date = as.Date(claim_filed_date))
```

```{r}
cla %>% 
  glimpse()
```

```{r}
cla %>% 
  mutate(
    year = as.factor(year(claim_filed_date)),
    month = as.factor(month(claim_filed_date))
  ) %>% 
  group_by(year, month) %>% 
  summarise(sum_price = sum(purchase_amount),
            subscrips = n()
  ) %>% 
  ungroup()  %>% 
  ggplot() +
  geom_point(mapping = aes(x = sum_price, y = subscrips))
```

```{r}
test_ratio <- 
  cla %>% 
  mutate(
    year = as.factor(year(claim_filed_date)),
    month = as.factor(month(claim_filed_date))
  ) %>% 
  group_by(year, month) %>% 
  summarise(sum_price = sum(purchase_amount),
            subscrips = n()
  ) %>% 
  ungroup() 

ratio <- max(test_ratio$subscrips)/max(test_ratio$sum_price)
test_ratio %>% 
  ggplot() +
  geom_col(aes(x = month, y = subscrips)) +
  geom_line(aes(x = month, y = sum_price * ratio, group = 1)) +
  scale_y_continuous("Count", sec.axis = sec_axis(~ . / ratio, name = ""))+
  facet_wrap(~year) +
  theme_minimal()
```


## Combined

```{r}
combined <- sub %>% 
  inner_join(
    cla,
    by =  "user_id"
  )  %>% 
  drop_na() %>%
  select(user_id,
         coverages_selected, 
         user_started_date,
         monthly_price,
         claim_filed_date,
         purchase_amount,
         claim_coverage_triggered,
         reason,
         area
  ) %>% 
  mutate(month_dff = lubridate::interval(user_started_date,
                                         claim_filed_date) %/%
           months(1),
         year = as.factor(year(claim_filed_date)),
         month = as.factor(month(claim_filed_date)))  %>% 
  mutate(false_claim =
           !map2_lgl(coverages_selected, 
                     claim_coverage_triggered, 
                     str_detect)
  )
```

```{r}
combined %>% 
  glimpse()
```


```{r}
combined %>% 
  group_by(area) %>% 
  count(false_claim) %>% 
  ggplot(aes(x=false_claim, y=n)) +
   geom_bar(stat="identity", position=position_dodge()) +
  facet_wrap(~area,
             scales = "free_y")
```

```{r}
combined %>% 
  mutate(fct_month_dff = as.factor(month_dff)) %>% 
  group_by(month_dff, false_claim) %>% 
  summarise(
    n = n()
  ) %>% 
    mutate(freq = n / sum(n)) %>% 
  mutate(month_dff = as.factor(month_dff)) %>% 
  filter(false_claim == "FALSE") %>% 
  ggplot() +
  geom_col(aes(month_dff, freq))
```
```{r}
combined %>% 
  mutate(fct_month_dff = as.factor(month_dff)) %>% 
  group_by(month_dff) %>% 
  summarise(
    n = n()
  ) %>% 
  mutate(month_dff = as.factor(month_dff)) %>% 
  ggplot() +
  geom_col(aes(month_dff, n) )
```


## Visning i shiny

* Via det generalle view i leaflet hvor deres målgruppe er.
* Vis den lineær sammenhæng mellem at desto flere subscirpter desto mere vokser
  deres indtjening. 
* Fokuser på dit fund med at der er en række som ikke får krævet erstatning
  til det rette formål, hvor der måske er lidt forvirring over hvor de skal 
  sætte deres trigger. 
