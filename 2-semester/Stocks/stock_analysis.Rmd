---
title: "Bambuser analyse"
description: |
  En simple analyse med indtroduktion til glidende gennemsnit indikator
author:
  - name: Lucas Bagge 
date: "`r Sys.Date()`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(quantmod)
library(highcharter)
library(dplyr)
library(magrittr)
library(tidyquant)
library(ggplot2)
library(plotly)
```

```{r}
SPY_tibble <- tq_get("FLS.CO", get="stock.prices")

stategies <- function(data, col){
  placeholder <- ifelse(col > 1, 0, 1)
  data_length <- nrow(data)
  for(i in 1:data_length) {
    placeholder[i] <- ifelse(col[i] == 1, 1, ifelse(col[i] == -1, 0, placeholder[i-1]))
  }
  placeholder[is.na(placeholder)] <- 1
  placeholder
}

SPY_tibble_1 <- 
  SPY_tibble %>% 
  tq_mutate(select = c(close), mutate_fun = SMA, n = 200) %>% 
  rename(SMA_200 = SMA) %>% 
  tq_mutate(select = c(close), mutate_fun = SMA, n = 50) %>% 
  mutate(sma5tr_tibble = Lag(case_when(
    Lag(close) < Lag(SMA) & close > SMA ~ 1,
    Lag(close) > Lag(SMA) & close < SMA ~ -1,
    TRUE ~ 0
  )),
  sma5pos_tibble = stategies(., sma5tr_tibble))  

highchart(type = "stock") %>% 
  hc_yAxis_multiples(
    create_yaxis(2, height = c(2, 1), turnopposite = TRUE)
  ) %>% 
  hc_add_series(SPY_tibble_1 %>% timetk::tk_xts(date_var = "date"), yAxis = 0, name = "SPY")  %>% 
  hc_add_series(SPY_tibble_1 %>% 
                  select(date, SMA) %>% 
                  timetk::tk_xts(date_var = "date"),
                yAxis = 0, 
                name = "SMA - 50") %>% 
  hc_add_series(SPY_tibble_1 %>% 
                  select(date, SMA_200) %>% 
                  timetk::tk_xts(date_var = "date"),
                yAxis = 0, 
                name = "SMA - 200")
  
```

```{r}
SPY_tibble_1 <- 
  SPY_tibble_1 %>% 
  relocate(SMA, .after = close) %>% 
  select(-c(volume, adjusted))
```

med sm5tr så hvis close er mindre end sma så bliver -1 og vi skal sælge


## Appendix

### SMA

```{r}
SPY %>% 
  tq_mutate(ohlc_fun = Cl, mutate_fun = SMA, n = 5) %>% 
  rename(SMA.5 = SMA) %>% 
  tq_mutate(ohlc_fun = Cl, mutate_fun = SMA, n = 21) %>%
  rename(SMA.21 = SMA) %>% 
  select(date, close, SMA.5, SMA.21) %>%
  tidyr::gather(key = type, value = price, close:SMA.21) %>% 
  hchart("line", hcaes(x = date, y = price, group = type))

```
- den smiple i rød minder mere om data. Den 21 er mere smooth. 

$$
\text{Buy signal: Previous (Close < } SMA_5) \rightarrow \text{Current (Slose > }SMA_5)\\
\text{Sell signal: Previous (Close > } SMA_5) \rightarrow \text{Current (Slose < }SMA_5)\\
$$

### EMA

```{r}
SPY %>% 
  # se på MA
  # # Cl er close.
  tq_mutate(ohlc_fun = Cl, mutate_fun = EMA, n = 5) %>% 
  rename(SMA.5 = EMA) %>% 
  tq_mutate(ohlc_fun = Cl, mutate_fun = EMA, n = 21) %>%
  rename(SMA.21 = EMA) %>% 
  select(date, close, SMA.5, SMA.21) %>%
  tidyr::gather(key = type, value = price, close:SMA.21) %>% 
  ggplot(aes(x = date, y = price, col = type)) +
  geom_line() +
  scale_colour_manual(values = my_palette) + 
  theme(legend.position="bottom") +
  ggtitle("Glidende gennemsnit") +
  xlab("") + 
  ylab("Stock Price") +
  theme_tq() 
```
- Minder om SMA i mønster.

## Bolling bands

```{r}
myBBands <- function (price,n,sd){
  mavg <- SMA(price,n)
  sdev <- rep(0,n)
  N <- nrow(price)
  for (i in (n+1):N){
    sdev[i]<- sd(price[(i-n+1):i])
  }
  sdev <- sqrt((n-1)/n)*sdev
  up <- mavg + sd*sdev
  dn <- mavg - sd*sdev
  pctB <- (price - dn)/(up - dn)
  output <- cbind(dn, mavg, up, pctB)
  colnames(output) <- c("dn", "mavg", "up", 
        "pctB")
  return(output)
}
```


```{r}
SPY %>% 
  ggplot(aes(x = date, y = close, 
             open = open, high = high, low = low, close = close, 
             group = symbol)) +
  geom_barchart() +
  geom_bbands(ma_fun = SMA, sd = 2, n = 20, linetype = 5) +
  labs(title = "FANG Bar Chart", 
       subtitle = "BBands with SMA Applied, Experimenting with Multiple Stocks", 
       y = "Closing Price", x = "") +
  theme_tq()

```
- en del af lag indikator.

## parabolix stop and reverse


```{r}
sar_value <- SPY %>% 
  tq_mutate(
    select = c(high, low),
    mutate_fun = SAR,
    accel = c(0.02, 0.2),
    col_rename = "sar") %>% 
  timetk::tk_xts(date_var = "date")

SPY %>% 
  timetk::tk_xts(date_var = "date") %>% 
  hchart() %>% 
  hc_add_series(sar_value$sar, type = "scatter")
```


## Average directional movement index indicator


```{r}
SPY %>% 
  tq_mutate(
    select = c("high", "low", "close"),
    mutate_fun = ADX,
    n = 14,
    maType = "SMA"
  ) %>% 
  tidyr::pivot_longer(
    cols = c("DIp", "DIn", "ADX"),
    names_to = "Indicator",
    values_to = "Indicator_value"
  ) %>% 
  hchart("line", hcaes(x = date, y = Indicator_value, group = Indicator )) 
```


## commodity channel index

```{r}
SPY %>% 
  tq_mutate(
    select = c("high", "low", "close"),
    mutate_fun = CCI,
    n = 14,
    maType = "SMA"
  ) %>% 
  hchart("line", hcaes(x = date, y = cci))
```


## (MACD) MOving aveagers convergence /divergence indicator

```{r}
SPY %>% 
  tq_mutate(select     = close, 
            mutate_fun = MACD, 
            nFast      = 12, 
            nSlow      = 26, 
            nSig       = 9, 
            maType     = SMA) %>%
  mutate(diff = macd - signal) %>%
  select(-(open:volume)) %>% 
  ggplot(aes(x = date)) + 
  geom_hline(yintercept = 0, color = palette_light()[[1]]) +
  geom_line(aes(y = macd)) +
  geom_line(aes(y = signal), color = "blue", linetype = 2) +
  geom_bar(aes(y = diff), stat = "identity", color = palette_light()[[1]]) +
  labs(title = "FANG: Moving Average Convergence Divergence",
       y = "MACD", x = "", color = "") +
  theme_tq() +
  scale_color_tq()
```


## Rate of change indicator


```{r}
SPY %>% 
  tq_mutate(select     = close, 
            mutate_fun = ROC, 
            n       = 21) %>%
  select(-(open:volume)) %>% 
  hchart("line", hcaes(x = date, y = ROC))
```

## Relative strength index

```{r}
SPY %>% 
  tq_mutate(select     = close, 
            mutate_fun = RSI, 
            n       = 14) %>%
  hchart("line", hcaes(x = date, y = rsi))

```


## Stochastic momentum index indicator

```{r}
SPY %>% 
  tq_mutate(select     = c(high, low, close), 
            mutate_fun = SMI, 
            n = 13,
            nFast = 2, 
            nSlow = 25,
            nSig = 9) %>% 
  tidyr::pivot_longer(
    cols = c("SMI", "signal"),
    names_to = "Indicator", 
    values_to = "Indicator_value"
  )  %>% 
  hchart("line", hcaes(date, Indicator_value, group = Indicator))
```


## Williams %R indicator

```{r}
SPY %>% 
  tq_mutate(select     = c(high, low, close), 
            mutate_fun = WPR, 
            n = 14) %>% 
  hchart("line", hcaes(x = date, y = WPR))
```
